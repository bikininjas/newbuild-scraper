<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Price Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    .main-content { width: 90vw; max-width: 1600px; margin: 0 auto; }
    @media (max-width: 900px) { .main-content { width: 98vw; } }
    canvas { background-color: rgba(15, 23, 42, 0.95) !important; border-radius: 8px; }
    .chart-bg canvas { max-height: 180px !important; height: 180px !important; }
    .hidden { display: none; }
    .glass-card { background: rgba(15, 23, 42, 0.95) !important; backdrop-filter: blur(16px); border: 1px solid rgba(51, 65, 85, 0.4); }
    .price-badge { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
    .toggle-btn { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); transition: all 0.3s ease; }
    .toggle-btn:hover { background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%); transform: translateY(-1px); }
    .chart-container { background: rgba(15, 23, 42, 0.95) !important; border-radius: 16px; padding: 24px; border: 1px solid rgba(51, 65, 85, 0.3); }
    .gradient-text { background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .price-item { background: rgba(15, 23, 42, 0.9) !important; border: 1px solid rgba(51, 65, 85, 0.4); }
    .price-item:hover { background: rgba(30, 41, 59, 0.9) !important; border-color: rgba(56, 189, 248, 0.3); }
    .history-item { background: rgba(15, 23, 42, 0.8) !important; border: 1px solid rgba(51, 65, 85, 0.3); }
    .history-item:hover { background: rgba(30, 41, 59, 0.8) !important; }
    .chart-bg { background: rgba(15, 23, 42, 0.98) !important; border: 1px solid rgba(51, 65, 85, 0.3); }
    * { box-sizing: border-box; }
    html, body { background: #0f172a !important; }
    table { background: rgba(15, 23, 42, 0.95) !important; }
    thead tr { background: rgba(30, 41, 59, 0.9) !important; }
    tbody tr { background: rgba(15, 23, 42, 0.8) !important; }
    tbody tr:hover { background: rgba(30, 41, 59, 0.8) !important; }
    th, td { border-color: rgba(51, 65, 85, 0.4) !important; }
    select { background: rgba(15, 23, 42, 0.95) !important; color: #e2e8f0 !important; border: 1px solid rgba(51, 65, 85, 0.4) !important; border-radius: 8px; padding: 8px 12px; font-size: 14px; }
    select:focus { outline: none; border-color: rgba(56, 189, 248, 0.5) !important; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1); }
    select option { background: rgba(15, 23, 42, 0.95) !important; color: #e2e8f0 !important; }
  </style>
</head>
<body class="bg-slate-900 font-inter min-h-screen">
<div class="main-content px-4 py-8">
<h1 class="text-5xl font-extrabold text-center gradient-text mb-12 tracking-tight">Product Price Tracker</h1>

<div id="total-warning"></div>
<div class="chart-container mt-8 mb-8"><h2 class="text-2xl font-bold text-center text-cyan-400 mb-6">Historique du prix total</h2><canvas id="total_price_chart" height="150"></canvas><script>
const ctx = document.getElementById("total_price_chart").getContext("2d");
new Chart(ctx, {"type": "line", "data": {"labels": [], "datasets": [{"label": "Prix Total (\u20ac)", "data": [], "fill": false, "borderColor": "#10b981", "backgroundColor": "#059669", "borderWidth": 3, "tension": 0.4, "pointRadius": 3, "pointHoverRadius": 6, "order": 1}]}, "options": {"responsive": true, "plugins": {"legend": {"display": true, "labels": {"color": "#e2e8f0", "font": {"size": 12}}}, "title": {"display": true, "text": "Historique du prix total", "color": "#06b6d4", "font": {"size": 16, "weight": "bold"}}}, "scales": {"x": {"ticks": {"color": "#94a3b8", "font": {"size": 10}}, "grid": {"color": "rgba(148, 163, 184, 0.1)"}}, "y": {"beginAtZero": false, "ticks": {"color": "#94a3b8", "font": {"size": 10}}, "grid": {"color": "rgba(148, 163, 184, 0.1)"}}}, "elements": {"point": {"hoverBackgroundColor": "#06b6d4"}, "line": {"borderCapStyle": "round"}}}});
</script></div>

<script id="excluded-categories" type="application/json">["Upgrade Kit"]</script>
<script>
    // Categories excluded from total computation (safely parsed from JSON script tag)
    try {
        var exScript = document.getElementById('excluded-categories');
        window.EXCLUDED_CATEGORIES = JSON.parse(exScript.textContent || '[]');
    } catch (e) {
        window.EXCLUDED_CATEGORIES = [];
    }

    function formatPrice(num) {
        var n = Number(num);
        if (!isFinite(n)) return '?';
        return n.toFixed(2) + '‚Ç¨';
    }

    function computeTotal() {
        var total = 0;
        var rows = document.querySelectorAll('#summary-table tbody tr');
        rows.forEach(function(row) {
            var cat = row.getAttribute('data-category');
            if (!cat) return; // skip header/total or malformed
            if (Array.isArray(window.EXCLUDED_CATEGORIES) && window.EXCLUDED_CATEGORIES.indexOf(cat) !== -1) return;
            var sel = row.querySelector('select[data-category]');
            if (!sel) return;
            var opt = sel.options[sel.selectedIndex];
            var price = parseFloat(opt && opt.dataset ? opt.dataset.price : 'NaN');
            if (!isNaN(price)) total += price;
        });
        var el = document.getElementById('total-price-value');
        if (el) el.textContent = formatPrice(total);
    }

    function switchComponent(category, selectEl) {
        // Persist selection
        try {
            var selections = JSON.parse(localStorage.getItem('componentSelections') || '{}');
            selections[category] = selectEl.value;
            localStorage.setItem('componentSelections', JSON.stringify(selections));
        } catch (e) { /* ignore */ }

        // Update row cells from selected option's data-* attributes
        var opt = selectEl.options[selectEl.selectedIndex];
        var row = selectEl.closest('tr');
        if (row && opt && opt.dataset) {
            var tds = row.querySelectorAll('td');
            // price cell is index 2, site index 3, date index 4
            var price = parseFloat(opt.dataset.price);
            if (tds[2]) tds[2].textContent = formatPrice(price);
            if (tds[3]) {
                var a = tds[3].querySelector('a');
                if (a) { a.href = opt.dataset.url || '#'; a.textContent = opt.dataset.site || a.textContent; }
            }
            if (tds[4]) tds[4].textContent = opt.dataset.date || '?';
        }
        // Recompute total
        computeTotal();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Apply stored selections without reloading
        var selections = {};
        try { selections = JSON.parse(localStorage.getItem('componentSelections') || '{}'); } catch(e) { selections = {}; }
        document.querySelectorAll('select[data-category]').forEach(function(sel) {
            var cat = sel.getAttribute('data-category');
            var saved = selections && selections[cat];
            if (saved) {
                for (var i = 0; i < sel.options.length; i++) {
                    if (sel.options[i].value === saved) { sel.selectedIndex = i; break; }
                }
                switchComponent(cat, sel);
            }
        });
        // Ensure total reflects current selections
        computeTotal();
    });
</script>

<div class="overflow-x-auto mb-10">
<table id="summary-table" class="min-w-full glass-card rounded-xl shadow-2xl border border-slate-600 overflow-hidden">
<thead><tr><th class="px-6 py-4 text-left text-sm font-semibold text-slate-200 bg-slate-900/70">Cat√©gorie</th><th class="px-6 py-4 text-left text-sm font-semibold text-slate-200 bg-slate-900/70">Produit</th><th class="px-6 py-4 text-left text-sm font-semibold text-slate-200 bg-slate-900/70">Meilleur Prix</th><th class="px-6 py-4 text-left text-sm font-semibold text-slate-200 bg-slate-900/70">Meilleur Site</th><th class="px-6 py-4 text-left text-sm font-semibold text-slate-200 bg-slate-900/70">Vu Le</th></tr></thead><tbody>
<tr id='total-row' class='bg-slate-900/80 font-bold border-t-2 border-cyan-500/30'><td class="border-t border-slate-700/50 px-6 py-4 text-slate-300">üí∞ Total</td><td class="border-t border-slate-700/50 px-6 py-5"></td><td id="total-price-value" class="border-t border-slate-700/50 px-6 py-4 font-bold text-green-400 text-lg">0.00‚Ç¨</td><td class="border-t border-slate-700/50 px-6 py-5"></td><td class="border-t border-slate-700/50 px-6 py-5"></td></tr>
</tbody></table></div>
<div class="text-sm text-yellow-300/80 mt-2">
‚ö†Ô∏è Upgrade Kit non inclus dans le total (alternative aux composants).</div>
<div class="grid gap-8">
</div>

<script>
// Toggle visibility of price history sections (inlined)
function toggleHistory(historyId) {
    const historyDiv = document.getElementById(historyId);
    const icon = document.getElementById("icon-" + historyId);
    const button = icon ? icon.parentElement : null;
    if (!historyDiv) return;
    if (historyDiv.classList.contains("hidden")) {
        historyDiv.classList.remove("hidden");
        if (icon) icon.style.transform = "rotate(180deg)";
        if (button) {
            const textNode = Array.from(button.childNodes).find(n => n.nodeType === 3 && n.textContent.includes("Afficher"));
            if (textNode) textNode.textContent = "Masquer l'historique des prix";
        }
    } else {
        historyDiv.classList.add("hidden");
        if (icon) icon.style.transform = "rotate(0deg)";
        if (button) {
            const textNode = Array.from(button.childNodes).find(n => n.nodeType === 3 && n.textContent.includes("Masquer"));
            if (textNode) textNode.textContent = "Afficher l'historique des prix";
        }
    }
}
</script>

</body></html>